---
title: "Project"
author: "Victoria (Tori) Widjaja & Jeremiah Fa'atiliga"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r libraries, warning=FALSE, message=FALSE}
#install.packages("gt")
#install.packages("skimr")
#install.packages("gtsummary")
#install.packages("GGally")

library(readr)
library(caret)
library(tidyverse)
library(kernlab)
library(tibble)
library(ggplot2)
library(purrr)
library(dplyr)
library(tidyr)
library(skimr)
library(gtsummary)
library(GGally)
library(plotmo)
library(earth)
library(corrplot)
#library(patchwork)
#library(AppliedPredictiveModeling)
library(gt)
#library(randomForest)
```

```{r loading, warning=FALSE, message=FALSE}

dir_prefix <- getwd()
print(dir_prefix)

### Connection info for GitHub File
url <- paste(dir_prefix, 'healthcare-dataset-stroke-data.csv', sep ='/')
df_orig <- read_csv(url)
print(url)


```

## Exploratory Data Analysis (EDA)

```{r}
###graphical and non-graphical representations of relationships between the response variable and predictor variables

```

words words words

```{r warning=FALSE, message=FALSE}

df_eda <- select(df_orig, -id)
summary(df_eda)


# Filter out N/A values for bmi and convert to numeric
df_eda <- df_eda %>%
  filter(!is.na(bmi)) %>%
  mutate(bmi = as.numeric(bmi))

# Pivot longer and convert value column to numeric if possible
df_long <- df_eda %>%
  pivot_longer(-c(stroke, ever_married, gender, hypertension, heart_disease, Residence_type, work_type, smoking_status), names_to = "Variable", values_to = "value") %>%
  mutate(value = as.numeric(value))

# Plot histograms
ggplot(df_long, aes(x = value)) +
  geom_histogram(bins = 20) +
  facet_wrap(~Variable, scales = "free", ncol = 2) + 
  theme_bw() +
  labs(title = 'Histograms of Variables Distributions', x = NULL, y = "Count")

```

```{r warning=FALSE, message=FALSE, fig.width=7,fig.height=6}

numeric_df <- df_eda[sapply(df_eda, is.numeric)]

numeric_df |>
  ggpairs(title = "Relationship Between Predictors", progress = FALSE)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}

stroke_percent <- prop.table(table(df_eda$stroke)) * 100

barplot(stroke_percent, 
        main = "Percentage of Strokes", 
        xlab = "Stroke", 
        ylab = "Percentage",
        col = "lightblue",
        ylim = c(0, max(stroke_percent) + 11),
        names.arg = c("No Stroke", "Stroke"))

label_pos <- stroke_percent + 1

### Add labels
text(x = 1:length(stroke_percent), 
     y = label_pos, 
     labels = paste0(round(stroke_percent, 2), "%"), 
     pos = 3)

```

```{r}

non_numeric_columns <- names(df_eda)[sapply(df_eda, is.factor) | sapply(df_eda, is.character)]

plots_list <- map(non_numeric_columns, ~ {
  col <- .x
  
  counts <- table(df_eda[[col]], df_eda$stroke)
  counts_df <- as.data.frame(counts)
  names(counts_df) <- c(col, "stroke", "count")

  ggplot(counts_df, aes(x = !!sym(col), y = count, fill = factor(stroke))) +
    geom_bar(stat = "identity") +
    labs(x = col, y = "Count of Records", title = paste("Bar Graph of Stroke by", col)) +
    facet_wrap(~stroke, scales = "free") +  ### facet by stroke
    theme(axis.text.x = element_text(angle = 45, hjust = 1))  
})

walk(plots_list, print)

```

## Data Wrangling and Pre-Processing

```{r}
summary_df <- tibble(
  Variable = names(df_eda),
  Missing_Values = colSums(is.na(df_eda))
) %>%
  arrange(desc(Missing_Values))

###add a filter for high and low
highest_missing <- summary_df %>%
  filter(Missing_Values == max(Missing_Values))
lowest_missing <- summary_df %>%
  filter(Missing_Values == min(Missing_Values))

### Combine the highest and lowest missing values
result_df <- bind_rows(highest_missing, lowest_missing) %>%
  filter(Variable != "stroke") %>%
  gt() %>%
  tab_header(title = "Summary of Missing Values") %>%
  cols_label(
    Variable = "Variable",
    Missing_Values = "Count of Missing Values"
  )

### Print Out 
result_df
```

```{r}
###handling of missing values, outliers, correlated features, etc.

###Imputing Missing BMI Values

###Create age ranges
df_eda <- df_eda %>%
  mutate(age_range = cut(age, breaks = seq(0, max(age) + 10, by = 10),
                        labels = paste0(seq(0, max(age), by = 10), "-", seq(9, max(age) + 9, by = 10))))

# Calculate median "bmi" for each age range
median_bmi <- df_eda %>%
  group_by(age_range) %>%
  summarise(median_bmi = median(bmi, na.rm = TRUE))
median_bmi
```

```{r}

# Join median_bmi with df_eda to impute missing "bmi" values
df_eda <- df_eda %>%
  left_join(median_bmi, by = "age_range") %>%
  mutate(bmi = ifelse(is.na(bmi), median_bmi, bmi)) %>%
  select(-median_bmi, -age_range)

# Display first few rows of the updated dataframe
head(df_eda)
```

```{r}

na_counts <- colSums(is.na(df_eda))

na_counts_df <- data.frame(variable = names(na_counts), na_count = na_counts)

### gt() Table
na_table <- na_counts_df %>%
  gt() %>%
  tab_header(title = "NA Counts in DataFrame") %>%
  cols_label(variable = "Variable", na_count = "NA Count")

na_table

```

```{r}
df_feature_select <- df_eda
### Convert Stroke to factor
df_feature_select$stroke <- as.factor(df_feature_select$stroke)
str(df_feature_select)
```

## Feature Selection

```{r}
# Define the target variable and the features
x <- df_feature_select[, setdiff(names(df_feature_select), "stroke")]
y <- df_feature_select$stroke

# Control parameters for RFE
control <- rfeControl(functions = rfFuncs, method = "repeatedcv", number = 10)

# Perform Recursive Feature Elimination (RFE)
results <- rfe(x, 
               y, 
               sizes = c(1:5), 
               rfeControl = control)

# Print the results
print(results)
plot(results)
```

## Data Splitting - Training & Test

```{r}
###training, validation, and test sets
```

## Data Prep

```{r}

```

## Models

```{r}
###model tuning and evaluation per and sum at the end
```

### Model #1 Baseline

```{r}

```

### Model #2

```{r}

```

### Model #3

```{r}

```

### Model #4

```{r}

```

### Results - Summary Table

```{r}
###use gt() table for all results
```
